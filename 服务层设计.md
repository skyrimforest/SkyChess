
# 🎮 国际象棋服务层 Prompt（SSE / 单文件后端 / 可玩型前端）

## 任务目标

在**已有算法层（algorithms_core）**的基础上，实现一个：

* 使用 **FastAPI + SSE（Server-Sent Events）** 的服务层
* **不使用 WebSocket**
* 后端尽量压缩为 **单个 Python 文件**
* 前端功能完整、交互顺畅
* 可用于：

  * 人类 vs AI
  * AI vs AI
  * 算法参数调试
  * 观察搜索强度与评估变化

最终体验应为：
👉 启动后端
👉 打开浏览器
👉 选算法 → 下棋 → 看评分 → 切换算法 → 看 AI 对战
👉 **“能一直玩下去”**

---

## 1️⃣ 总体架构约束

```
chess_app/
├── main.py              # FastAPI 单文件后端
├── frontend/
│   ├── index.html
│   ├── app.js
│   ├── api.js
│   ├── state.js
│   └── components/
│       ├── board.js
│       ├── control.js
│       ├── eval.js
│       └── movelist.js
└── README.md
```

### 强约束

* 后端：

  * **只用 FastAPI**
  * **不用 WebSocket**
  * **用 SSE 推送状态变化**
* 前端：

  * **轮询 + SSE 混合即可**
  * 不在前端实现任何棋规

---

## 2️⃣ 后端设计（FastAPI 单文件）

### 2.1 后端职责边界

后端只做三件事：

1. **管理对局状态**
2. **调度算法层 Agent**
3. **向前端广播状态变化（SSE）**

后端**不关心 UI，不缓存算法内部数据**。

---

### 2.2 全局状态设计（简化但安全）

```python
GAMES: dict[str, ChessGame]
AGENTS: dict[str, dict[color, ChessAgent]]
SUBSCRIBERS: dict[str, list[Queue]]
```

* 一个 game_id 对应：

  * 一个 ChessGame
  * 两个 Agent（white / black）
* 每个 SSE 订阅使用一个 `asyncio.Queue`

---

## 3️⃣ SSE 事件流设计（核心）

### 3.1 SSE Endpoint

```http
GET /events/{game_id}
```

* Content-Type: `text/event-stream`
* 用于推送：

  * 新局面
  * AI 走子完成
  * 评估分数变化
  * 对局结束

---

### 3.2 SSE 事件格式（简洁）

```text
event: state
data: {
  "fen": "...",
  "current_player": "black",
  "eval": -0.42,
  "history": ["e2e4", "e7e5"]
}
```

事件类型建议：

* `state`
* `ai_move`
* `game_over`

---

## 4️⃣ HTTP API（同步控制）

### 4.1 对局控制

```http
POST /game/new
POST /game/reset/{game_id}
GET  /game/state/{game_id}
```

---

### 4.2 玩家与 AI 行为

```http
POST /game/move/{game_id}
POST /game/ai_move/{game_id}
```

* AI 走子：

  * 同步调用 Agent.act
  * 完成后推送 SSE

---

### 4.3 算法切换（热切换）

```http
POST /game/set_agent/{game_id}
```

请求示例：

```json
{
  "color": "black",
  "agent": {
    "type": "mcts",
    "simulations": 800
  }
}
```

要求：

* 不重置棋局
* 立即生效
* 后续走子使用新 Agent

---

## 5️⃣ 前端设计（功能优先）

### 技术要求

* 原生 JS 或 TS
* 不依赖复杂框架
* **SSE + fetch 即可**

---

## 6️⃣ 前端功能模块（必须实现）

### ♟️ 棋盘（Board）

* 基于 FEN 渲染
* 点击走子
* 高亮合法走法（从后端获取）
* 禁止非法输入

---

### 🎛️ 控制面板（Control Panel）

* 白方 / 黑方算法选择
* 算法参数（depth / simulations / skill）
* AI Move 按钮
* AI vs AI 自动连走开关
* 重开对局

---

### 📊 评估显示（Eval）

* 数值显示（+0.53 / -1.2）
* 纵向 Eval Bar（白优 / 黑优）
* 随 SSE 自动刷新

---

### 📜 步骤列表（Move List）

* SAN / UCI 格式
* 当前步高亮
* 可滚动查看历史

---

### 🧠 状态提示（推荐）

* 当前执棋方
* 是否终局
* 胜负结果

---

## 7️⃣ 前后端通信模式（简化）

* **HTTP**

  * 玩家操作
  * 算法切换
* **SSE**

  * 局面变化
  * AI 行动完成
  * 评估更新

> 不使用 WebSocket
> 不实现双向推流
> 保证调试简单（curl / 浏览器直接看）

---

## 8️⃣ 快乐游玩模式（强制支持）

必须支持：

1. 人类执白 / AI 执黑
2. AI vs AI（一步一步 or 自动）
3. 中途切换算法（如 Minimax → Stockfish）
4. 调参数立刻生效
5. 看着 Eval 变化“品算法”

---

## 9️⃣ README 要求

README 中必须包含：

* 如何启动（一步到位）
* SSE 工作原理说明
* 前端功能说明
* 如何新增算法并自动出现在 UI 中

---

## 10️⃣ 输出要求

请输出：

1. **单文件 FastAPI 后端（main.py）**
2. **完整前端代码**
3. README.md
4. 可直接运行的示例
